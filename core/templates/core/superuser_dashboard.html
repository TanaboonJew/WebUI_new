{% extends "base.html" %}
{% block content %}

<style>
tr.updated {
  animation: flash 0.3s ease-in-out;
}

@keyframes flash {
  from { background-color: #ffffcc; }
  to { background-color: transparent; }
}
</style>

<div class="container mt-4">
  <h2 class="mb-4 text-center">System All Users Usage Dashboard</h2>

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead class="table-dark">
        <tr>
          <th>Username</th>
          <th>Docker</th>
          <th>Jupyter</th>
          <th>Disk (GB)</th>
          <th>CPU (%)</th>
          <th>GPU (%)</th>
          <th>Last Updated</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usage-table-body">
        {% for usage in usages %}
        <tr id="row-{{ usage.user.username }}">
          <td><strong>{{ usage.user.username }}</strong></td>
          <td>
            {% if usage.docker_status == "running" %}
              <span class="badge bg-success">running</span>
            {% else %}
              <span class="badge bg-danger">stopped</span>
            {% endif %}
          </td>
          <td>
            {% if usage.jupyter_status == "running" %}
              <span class="badge bg-success">running</span>
            {% else %}
              <span class="badge bg-danger">stopped</span>
            {% endif %}
          </td>
          <td>{{ usage.disk_usage }}</td>
          <td>
            <div class="progress" style="height: 20px;">
              <div id="cpu-progress-{{ usage.id }}" class="progress-bar {% if usage.cpu_usage > 80 %}bg-danger{% else %}bg-success{% endif %}" role="progressbar" style="width: {{ usage.cpu_usage }}%;">
                <span id="cpu-text-{{ usage.id }}">{{ usage.cpu_usage }}%</span>
              </div>
            </div>
          </td>
          <td>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar 
                  {% if usage.gpu_usage > 80 %}
                    bg-danger
                  {% elif usage.gpu_usage > 50 %}
                    bg-warning
                  {% else %}
                    bg-success
                  {% endif %}"
                  role="progressbar"
                  style="width: {{ usage.gpu_usage }}%;">
                {{ usage.gpu_usage }}%
              </div>
            </div>
          </td>
          <td>{{ usage.updated_at|date:"Y-m-d H:i:s" }}</td>
          <td>
            <a href="{% url 'allocate-resources' usage.user.id %}" class="btn btn-sm btn-primary">
              Allocate Resources
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function getColorClass(percent) {
  if (percent > 80) return 'bg-danger';
  if (percent > 50) return 'bg-warning';
  return 'bg-success';
}

function createRow(usage) {
  return `
    <tr id="row-${usage.username}">
      <td><strong>${usage.username}</strong></td>
      <td>
        <span class="badge ${usage.docker_status === 'running' ? 'bg-success' : 'bg-danger'}">
          ${usage.docker_status}
        </span>
      </td>
      <td>
        <span class="badge ${usage.jupyter_status === 'running' ? 'bg-success' : 'bg-danger'}">
          ${usage.jupyter_status}
        </span>
      </td>
      <td>${usage.disk_usage}</td>
      <td>
        <div class="progress" style="height: 20px;">
          <div class="progress-bar ${getColorClass(usage.cpu_usage)}" 
               style="width: ${usage.cpu_usage}%;"
               role="progressbar" aria-valuenow="${usage.cpu_usage}" aria-valuemin="0" aria-valuemax="100">
            ${usage.cpu_usage}%
          </div>
        </div>
      </td>
      <td>
        <div class="progress" style="height: 20px;">
          <div class="progress-bar ${getColorClass(usage.gpu_usage)}" 
               style="width: ${usage.gpu_usage}%;"
               role="progressbar" aria-valuenow="${usage.gpu_usage}" aria-valuemin="0" aria-valuemax="100">
            ${usage.gpu_usage}%
          </div>
        </div>
      </td>
      <td>${usage.updated_at}</td>
      <td>
        <a href="/allocate/${usage.id}/" class="btn btn-sm btn-primary">Allocate Resources</a>
      </td>
    </tr>
  `;
}

function setupWebSocket() {
  const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${protocol}://${window.location.host}/ws/monitoring/`;
  const socket = new WebSocket(wsUrl);

  socket.onopen = function() {
    console.log("WebSocket connected.");
  };

  socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    console.log("WebSocket Data:", data);
    if (data.usages) {
      const tbody = document.getElementById("usage-table-body");

      data.usages.forEach(usage => {
        const rowId = `row-${usage.username}`;
        const newRowHtml = createRow(usage);
        const existingRow = document.getElementById(rowId);

        if (existingRow) {
          // Replace only the specific row
          const newRow = document.createElement('tr');
          newRow.innerHTML = newRowHtml.trim();
          newRow.id = rowId;
          newRow.classList.add("updated");

          existingRow.replaceWith(newRow);

          // Remove flash class after animation
          setTimeout(() => newRow.classList.remove("updated"), 300);
        } else {
          tbody.insertAdjacentHTML("beforeend", newRowHtml);
        }
      });
    }
  };

  socket.onclose = function() {
    console.log("WebSocket disconnected. Reconnecting in 5 seconds...");
    setTimeout(setupWebSocket, 5000);
  };

  socket.onerror = function(error) {
    console.error("WebSocket error:", error);
    socket.close();
  };
}

document.addEventListener("DOMContentLoaded", function() {
  setupWebSocket();
});
</script>
{% endblock %}
